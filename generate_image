#!/usr/bin/env python3

import base64
import os
import sys
from datetime import datetime

import requests

OPENROUTER_API_KEY = ""
OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions"
MODEL = "google/gemini-2.5-flash-image-preview"
MODEL = "google/gemini-3-pro-image-preview"


def generate_image(prompt: str) -> bytes:
    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "Content-Type": "application/json",
    }

    payload = {
        "model": MODEL,
        "messages": [{"role": "user", "content": prompt}],
        "modalities": ["image", "text"],
        "image_config": {"aspect_ratio": "16:9"},
    }

    print(f"Sending request to OpenRouter with prompt: {prompt[:50]}...")
    response = requests.post(OPENROUTER_API_URL, json=payload, headers=headers)

    if response.status_code != 200:
        print(f"Error: {response.status_code}")
        print(f"Response: {response.text}")
        sys.exit(1)

    data = response.json()

    if "choices" in data and len(data["choices"]) > 0:
        message = data["choices"][0].get("message", {})
        if "images" in message and len(message["images"]) > 0:
            image_data = message["images"][0]
            image_url = image_data.get("image_url", {}).get("url")
            if image_url:
                if image_url.startswith("data:image/png;base64,"):
                    base64_str = image_url.replace("data:image/png;base64,", "")
                    return base64.b64decode(base64_str)
                elif image_url.startswith("data:image/jpeg;base64,"):
                    base64_str = image_url.replace("data:image/jpeg;base64,", "")
                    return base64.b64decode(base64_str)
                else:
                    img_response = requests.get(image_url)
                    if img_response.status_code == 200:
                        return img_response.content
                    else:
                        print(f"Error downloading image: {img_response.status_code}")
                        sys.exit(1)

    print("No image data in response")
    print(f"Full response: {data}")
    sys.exit(1)


def save_image(image_data: bytes, prompt: str) -> str:
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"generated_image_{timestamp}.png"
    filepath = os.path.join(os.getcwd(), filename)

    with open(filepath, "wb") as f:
        f.write(image_data)

    print(f"Image saved to: {filepath}")
    return filepath


def main():
    if len(sys.argv) < 2:
        print("Usage: python generate_image.py '<prompt>'")
        print("Example: python generate_image.py 'A beautiful sunset over mountains'")
        sys.exit(1)

    prompt = " ".join(sys.argv[1:])
    print(f"Generating image for prompt: {prompt}")

    image_data = generate_image(prompt)
    save_image(image_data, prompt)
    print("Done!")


if __name__ == "__main__":
    main()
